# 需求文档

## 简介

本文档规定了将 AI 测评应用从 Vercel + Supabase 架构迁移到完全自托管的 Railway 部署（使用 Railway PostgreSQL 数据库）的需求。此次迁移旨在实现完全的数据所有权、通过后端 API 层提高安全性，以及在单一平台上简化基础设施管理。

## 术语表

- **前端应用**: 用户交互的 React + TypeScript 单页应用程序
- **后端API**: 处理 API 请求和数据库操作的 Node.js Express 服务器
- **Railway数据库**: Railway 平台提供的 PostgreSQL 数据库服务
- **测评记录**: 包含分数和答案的单个用户测评提交
- **群组**: 用于分段测评数据的组标识符（例如 "default"、"company-2024"）
- **Supabase客户端**: 当前用于数据库操作的 @supabase/supabase-js SDK
- **迁移脚本**: 创建和修改数据库架构的 SQL 文件

## 需求

### 需求 1: 后端 API 服务器

**用户故事:** 作为系统架构师，我希望有一个 Node.js 后端 API 服务器，以便我可以安全地处理所有数据库操作，而不会向前端暴露凭据。

#### 验收标准

1. 后端API 应当使用 Express.js 框架和 TypeScript
2. 当 后端API 启动时，后端API 应当使用环境变量连接到 Railway数据库
3. 后端API 应当从 dist 目录为 前端应用 提供静态文件服务
4. 后端API 应当实现 CORS 中间件以允许前端请求
5. 后端API 应当实现请求体解析中间件以处理 JSON 负载
6. 后端API 应当监听由 PORT 环境变量指定的端口

### 需求 2: 测评提交 API

**用户故事:** 作为用户，我希望提交我的测评结果，以便我的分数可以被存储并包含在群组统计中。

#### 验收标准

1. 当 向 /api/assessments 发送包含有效测评数据的 POST 请求时，后端API 应当将记录插入到 Railway数据库
2. 当 测评数据无效（缺少必填字段或分数超出范围）时，后端API 应当返回带有验证详情的 400 错误
3. 当 数据库插入成功时，后端API 应当返回 201 状态和创建的记录 ID
4. 当 数据库插入失败时，后端API 应当返回带有错误详情的 500 错误
5. 后端API 应当验证总分在 0 到 30 之间
6. 后端API 应当验证每个维度分数（d1-d5）在 0 到 6 之间
7. 后端API 应当在未提供时将默认群组设置为 "default"
8. 后端API 应当在未提供时将默认名称设置为 "匿名用户"

### 需求 3: 统计检索 API

**用户故事:** 作为用户，我希望查看我所在群组的聚合统计数据，以便我可以将我的表现与其他人进行比较。

#### 验收标准

1. 当 向 /api/assessments/stats/:cohort 发送 GET 请求时，后端API 应当返回该群组的聚合统计数据
2. 后端API 应当计算总数、所有维度的平均分数、最小和最大总分
3. 当 该群组不存在测评时，后端API 应当返回 null 或空统计数据
4. 当 数据库查询失败时，后端API 应当返回 500 错误
5. 后端API 应当以 JSON 格式返回统计数据，匹配当前 Supabase 视图结构

### 需求 4: 最近测评 API

**用户故事:** 作为查看统计数据的用户，我希望看到最近的测评提交，以便我可以了解最新趋势。

#### 验收标准

1. 当 向 /api/assessments/recent/:cohort 发送 GET 请求时，后端API 应当返回按创建时间降序排列的最近测评
2. 后端API 应当接受可选的 limit 查询参数（默认 50，最大 100）
3. 后端API 应当仅返回非敏感字段（id、name、total、title、d1-d5、created_at）
4. 当 数据库查询失败时，后端API 应当返回 500 错误

### 需求 5: 测评分布 API

**用户故事:** 作为查看统计数据的用户，我希望看到分数分布数据，以便我可以在图表中可视化趋势。

#### 验收标准

1. 当 向 /api/assessments/distribution/:cohort 发送 GET 请求时，后端API 应当返回包含分数和时间戳的测评记录
2. 后端API 应当将结果限制为最近的 1000 条记录
3. 后端API 应当按创建时间降序排列结果
4. 当 数据库查询失败时，后端API 应当返回 500 错误

### 需求 6: 数据库架构迁移

**用户故事:** 作为开发人员，我希望将数据库架构迁移到 Railway PostgreSQL，以便数据结构与当前的 Supabase 实现匹配。

#### 验收标准

1. 迁移脚本 应当创建包含所有必需列和约束的 ai_assessments 表
2. 迁移脚本 应当在 cohort 和 created_at 列上创建索引以提高查询性能
3. 迁移脚本 应当创建 ai_assessment_public_stats 视图用于聚合统计
4. 迁移脚本 应当是幂等的（可以安全地多次运行）
5. 迁移脚本 应当使用与当前 Supabase 架构相同的数据类型和约束

### 需求 7: 前端 API 客户端重构

**用户故事:** 作为前端开发人员，我希望用 REST API 调用替换 Supabase 客户端调用，以便前端可以与新后端配合工作。

#### 验收标准

1. 当 前端应用 需要提交测评时，前端应用 应当向 /api/assessments 发送 POST 请求
2. 当 前端应用 需要统计数据时，前端应用 应当向 /api/assessments/stats/:cohort 发送 GET 请求
3. 当 前端应用 需要最近测评时，前端应用 应当向 /api/assessments/recent/:cohort 发送 GET 请求
4. 当 前端应用 需要分布数据时，前端应用 应当向 /api/assessments/distribution/:cohort 发送 GET 请求
5. 前端应用 应当移除 @supabase/supabase-js 依赖
6. 前端应用 应当优雅地处理 API 错误并显示用户友好的消息
7. 前端应用 应当使用与之前相同的数据接口以最小化更改

### 需求 8: 环境配置

**用户故事:** 作为 DevOps 工程师，我希望有清晰的环境变量配置，以便我可以轻松地将应用程序部署到 Railway。

#### 验收标准

1. 后端API 应当从环境变量读取 DATABASE_URL 用于 PostgreSQL 连接
2. 后端API 应当从环境变量读取 PORT（默认 3000）
3. 后端API 应当从环境变量读取 NODE_ENV 以确定生产/开发模式
4. 前端应用 应当从环境变量读取 VITE_API_URL 用于后端 API 端点
5. 系统 应当提供 .env.example 文件记录所有必需的变量
6. 系统 应当为 Railway 部署配置提供清晰的文档

### 需求 9: Railway 部署配置

**用户故事:** 作为开发人员，我希望有自动化的 Railway 部署配置，以便应用程序可以正确部署而无需手动干预。

#### 验收标准

1. 系统 应当包含指定构建和启动命令的 railway.json 或 Procfile
2. 系统 应当配置 Railway 以提供 PostgreSQL 数据库服务
3. 系统 应当配置 Railway 将数据库链接到应用程序服务
4. 系统 应当在 RAILWAY_DEPLOYMENT.md 文件中记录部署步骤
5. 系统 应当在 package.json 的 engines 字段中指定 Node.js 版本要求

### 需求 10: 安全性和限流

**用户故事:** 作为系统管理员，我希望有基本的安全措施，以便 API 受到保护免受滥用和恶意请求。

#### 验收标准

1. 后端API 应当在测评提交端点上实现限流（每个 IP 每分钟最多 10 个请求）
2. 后端API 应当在数据库操作之前验证和清理所有用户输入
3. 后端API 应当使用参数化查询以防止 SQL 注入
4. 后端API 应当实现请求大小限制以防止负载攻击
5. 后端API 应当记录所有 API 请求的时间戳和 IP 地址以进行监控

### 需求 11: 错误处理和日志记录

**用户故事:** 作为开发人员，我希望有全面的错误处理和日志记录，以便我可以调试问题并监控应用程序健康状况。

#### 验收标准

1. 当 后端API 中发生错误时，后端API 应当记录带有堆栈跟踪和上下文的错误
2. 当 数据库连接失败时，后端API 应当记录错误并返回 503 Service Unavailable 响应
3. 后端API 应当记录所有传入请求的方法、路径和响应状态
4. 后端API 应当适当使用不同的日志级别（info、warn、error）
5. 后端API 在生产环境错误响应中不应当暴露敏感信息（数据库凭据、堆栈跟踪）

### 需求 12: 向后兼容性和测试

**用户故事:** 作为 QA 工程师，我希望确保迁移后的系统保持所有现有功能，以便用户体验不会中断。

#### 验收标准

1. 迁移后的系统 应当支持所有现有的测评提交字段
2. 迁移后的系统 应当以与 Supabase 实现相同的格式返回统计数据
3. 迁移后的系统 应当保持相同的 API 响应结构以实现前端兼容性
4. 系统 应当包含迁移验证清单
5. 系统 应当支持在过渡期间同时运行 Supabase 和 Railway 后端（通过环境标志）
