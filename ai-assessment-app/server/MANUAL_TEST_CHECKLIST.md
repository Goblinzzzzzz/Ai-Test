# 手动功能测试检查清单

## 快速参考

使用此清单快速验证所有功能。在执行每个测试后，标记 ✓ 或 ✗。

## 测试前准备

- [ ] PostgreSQL 数据库已启动
- [ ] 迁移脚本已运行 (`migrations/init.sql`)
- [ ] 环境变量已配置 (`.env` 文件)
- [ ] 后端服务器已启动 (`npm start`)
- [ ] 服务器健康检查通过

## 需求 12.1: 完整的测评提交流程

### 基本提交功能

- [ ] **测试 1.1**: 提交完整有效测评
  - 返回 201 状态码
  - 响应包含 `success: true`
  - 响应包含生成的 UUID
  
- [ ] **测试 1.2**: 提交测评（使用默认值）
  - 不提供 name，默认为 "匿名用户"
  - 不提供 cohort，默认为 "default"
  - 返回 201 状态码

- [ ] **测试 1.3**: 提交边界值测评
  - 最小值 (total=0, d1-d5=0) 接受
  - 最大值 (total=30, d1-d5=6) 接受
  - 返回 201 状态码

### 数据持久化

- [ ] 提交的数据正确存储在数据库
- [ ] 所有字段值正确
- [ ] 时间戳自动生成

## 需求 12.2: 统计页面数据显示

### 统计数据

- [ ] **测试 2.1**: 获取群组统计
  - 返回 200 状态码
  - 包含 total_count
  - 包含 avg_total, avg_d1-d5
  - 包含 min_total, max_total
  - 统计计算正确

### 最近测评

- [ ] **测试 2.2**: 获取最近测评列表
  - 返回 200 状态码
  - 返回数组格式
  - 记录数 ≤ limit 参数
  - 按 created_at 降序排列
  - 不包含完整 answers 字段
  - 不包含 user_agent 字段

### 分布数据

- [ ] **测试 2.3**: 获取分布数据
  - 返回 200 状态码
  - 返回数组格式
  - 记录数 ≤ 1000
  - 包含 total, d1-d5, created_at

### 空结果处理

- [ ] **测试 2.4**: 查询不存在的群组
  - 返回 200 状态码
  - data 为 null 或 total_count 为 0
  - 不返回错误

## 需求 12.3: 错误场景处理

### 输入验证

- [ ] **测试 3.1**: 总分超出范围
  - total > 30 返回 400
  - total < 0 返回 400
  - 错误消息清晰

- [ ] **测试 3.2**: 维度分数超出范围
  - d1-d5 > 6 返回 400
  - d1-d5 < 0 返回 400
  - 错误消息指出具体字段

- [ ] **测试 3.3**: 缺少必填字段
  - 缺少 title 返回 400
  - 缺少 answers 返回 400
  - 缺少任何 d1-d5 返回 400
  - 错误消息列出缺少的字段

### 格式错误

- [ ] **测试 3.4**: 无效 JSON
  - 返回 400 状态码
  - 错误消息指出 JSON 格式错误

### 安全性

- [ ] **测试 3.5**: SQL 注入防护
  - 恶意 SQL 输入被安全处理
  - 数据库未受影响
  - 不返回数据库错误

### 限流保护

- [ ] **测试 3.6**: 限流机制
  - 快速发送 12 个请求
  - 第 11 个左右返回 429
  - 错误消息友好

### 网络错误

- [ ] **测试 3.7**: 服务器不可用
  - 前端显示友好错误消息
  - 不暴露技术细节

## API 响应格式

### 成功响应

- [ ] 所有成功响应包含 `success: true`
- [ ] 所有成功响应包含 `data` 字段
- [ ] 格式一致: `{ success: true, data: {...} }`

### 错误响应

- [ ] 所有错误响应包含 `success: false`
- [ ] 所有错误响应包含 `error` 字段
- [ ] 错误包含 `message` 字段
- [ ] 验证错误包含 `details` 数组
- [ ] 格式一致: `{ success: false, error: {...} }`

## 与 Supabase 版本对比

### 功能一致性

- [ ] 提交测评功能一致
- [ ] 统计数据格式一致
- [ ] 最近测评格式一致
- [ ] 分布数据格式一致
- [ ] 所有字段名称匹配

### 数据格式

- [ ] 测评记录字段完全一致
- [ ] 统计数据字段完全一致
- [ ] 数据类型匹配
- [ ] 约束条件一致

### 新增功能

- [ ] 限流保护正常工作
- [ ] 增强的错误消息
- [ ] 结构化日志记录
- [ ] SQL 注入防护

## 性能检查

- [ ] 提交测评响应时间 < 500ms
- [ ] 统计查询响应时间 < 1000ms
- [ ] 最近测评查询响应时间 < 1000ms
- [ ] 分布数据查询响应时间 < 2000ms

## 日志检查

- [ ] 所有请求被记录
- [ ] 错误包含堆栈跟踪（开发环境）
- [ ] 日志包含时间戳
- [ ] 日志包含请求方法和路径
- [ ] 日志包含 IP 地址

## 数据库检查

- [ ] ai_assessments 表存在
- [ ] ai_assessment_public_stats 视图存在
- [ ] 索引已创建 (cohort, created_at)
- [ ] 约束正确应用
- [ ] 数据正确存储

## 前端集成

- [ ] 前端可以提交测评
- [ ] 前端可以查看统计
- [ ] 前端可以查看最近测评
- [ ] 前端错误处理正常
- [ ] 前端显示友好错误消息

## 部署验证

- [ ] Railway 环境变量已配置
- [ ] 数据库连接正常
- [ ] 静态文件服务正常
- [ ] CORS 配置正确
- [ ] 生产环境不暴露敏感信息

## 自动化测试

- [ ] `test-api.sh` 所有测试通过
- [ ] `manual-test.sh` 所有测试通过
- [ ] 测试输出清晰易读
- [ ] 测试覆盖所有场景

## 文档检查

- [ ] MANUAL_TESTING_GUIDE.md 完整
- [ ] MANUAL_TEST_RESULTS.md 已更新
- [ ] RAILWAY_DEPLOYMENT.md 准确
- [ ] README 包含测试说明

## 最终验证

- [ ] 所有测试通过
- [ ] 无已知问题
- [ ] 性能满足要求
- [ ] 与 Supabase 版本功能一致
- [ ] 准备好生产部署

## 测试执行命令

```bash
# 1. 启动服务器
cd ai-assessment-app/server
npm start

# 2. 运行快速测试
./test-api.sh

# 3. 运行完整测试
./manual-test.sh

# 4. 测试特定端点
curl http://localhost:3000/api/assessments/stats/default

# 5. 查看服务器日志
# 检查终端输出
```

## 问题记录

如果发现问题，记录在此：

| 问题 | 严重程度 | 描述 | 状态 |
|------|---------|------|------|
|      |         |      |      |

## 测试完成签署

- **测试人员**: _______________
- **测试日期**: _______________
- **测试环境**: _______________
- **测试结果**: [ ] 通过 [ ] 失败
- **备注**: _______________

---

## 快速命令参考

```bash
# 健康检查
curl http://localhost:3000/health

# 提交测评
curl -X POST http://localhost:3000/api/assessments \
  -H "Content-Type: application/json" \
  -d '{"total":25,"title":"测试","d1":5,"d2":5,"d3":5,"d4":5,"d5":5,"answers":{}}'

# 获取统计
curl http://localhost:3000/api/assessments/stats/default

# 获取最近测评
curl http://localhost:3000/api/assessments/recent/default?limit=10

# 获取分布数据
curl http://localhost:3000/api/assessments/distribution/default
```
